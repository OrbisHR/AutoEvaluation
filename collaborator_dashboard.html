<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Évaluation - ORBIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
         .progress-bar {
            height: 10px;
            border-radius: 5px;
            background-color: #e5e7eb;

            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            max-width: 120%;
        }
        .achievement-level {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .achievement-level:hover {
            transform: scale(1.05);
        }
        .achievement-level.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .print-only {
            display: none;
        }
        @media print {
            .no-print {
                display: none;
            }
            .print-only {
                display: block;
            }
            body {
                background: white;
                color: black;
            }
            .container {
                max-width: 100%;
                padding: 0;
            }
        }
        .sidebar {
            transition: all 0.3s ease;
        }
        .sidebar-collapsed {
            transform: translateX(-100%);
        }
        .sidebar-toggle {
            transition: all 0.3s ease;
        }
        .sidebar-toggle.collapsed {
            transform: rotate(180deg);
        }
        .objective-exceptionnel {
            border-left: 4px solid #8b5cf6;
            background-color: #f5f3ff;
        }
        .weight-warning {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
        .file-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        .file-upload:hover {
            border-color: #4299e1;
        }
        .file-upload.active {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar w-64 bg-blue-800 text-white min-h-screen fixed z-10">
            <div class="p-4 flex items-center justify-between border-b border-blue-700">
                <img src="./Logo.png" alt="Logo" class="h-12 w-12 mr-2"> <!-- Ajoutez le chemin de votre logo ici -->
                <h2 class="text-xl font-bold">PerformeIQ</h2>
                <button id="sidebar-toggle" class="sidebar-toggle text-white focus:outline-none">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-6">
                    <h3 class="text-sm uppercase font-semibold text-blue-300 mb-2">Auto-Évaluation</h3>
                    <ul>
                        <li class="mb-1">
                            <button id="nav-new" class="w-full text-left px-3 py-2 rounded-md bg-blue-700 flex items-center">
                                <i class="fas fa-plus-circle mr-2"></i> Nouvelle Auto-Évaluation
                            </button>
                        </li>
                        <li class="mb-1">
                            <button id="nav-saved" class="w-full text-left px-3 py-2 rounded-md hover:bg-blue-700 flex items-center">
                                <i class="fas fa-folder-open mr-2"></i> Auto-Évaluations Sauvegardées
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="flex-1 ml-64 transition-all duration-300">
            <div class="container mx-auto px-4 py-8">
                <div class="max-w-5xl mx-auto">
                    <!-- Header -->
                    <header class="mb-8 text-center">
                        <div class="flex justify-center mb-4">
                            <div class="bg-blue-100 p-4 rounded-full">
                                <i class="fas fa-user-check text-blue-600 text-3xl"></i>
                            </div>
                        </div>
                        <h1 class="text-3xl font-bold text-blue-800 mb-2">Auto-Évaluation des Objectifs</h1>
                        <h1 class="text-3xl font-bold text-blue-800 mb-2">Groupe ORBIS</h1>
                        <p id="welcome-message" class="text-lg text-gray-700 font-medium"></p> <!-- Conteneur pour le message de bienvenue -->
                        <p class="text-gray-600" id="page-subtitle">Importez vos objectifs et évaluez vos performances</p>
                        <div class="mt-4 print-only">
                            <p class="text-sm text-gray-500">Généré le <span id="print-date"></span></p>
                        </div>
                    </header>

                    <!-- User Input Section -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="collaborateur-name" class="block text-gray-700 mb-2 font-medium">
                                    <i class="fas fa-user mr-2 text-blue-500"></i>Nom et Prénom du Collaborateur
                                </label>
                                <input type="text" id="collaborateur-name" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre nom et prénom">
                            </div>
                            <div>
                                <label for="collaborateur-societe" class="block text-gray-700 mb-2 font-medium">
                                    <i class="fas fa-building mr-2 text-blue-500"></i>Société
                                </label>
                                <input type="text" id="collaborateur-societe" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre société">
                            </div>
                            <div>
                                <label for="evaluation-date" class="block text-gray-700 mb-2 font-medium">
                                    <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>Date d'auto-évaluation
                                </label>
                                <input type="date" id="evaluation-date" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="manager-name" class="block text-gray-700 mb-2 font-medium">
                                    <i class="fas fa-user-tie mr-2 text-blue-500"></i>Nom du Manager (N+1)
                                </label>
                                <input type="text" id="manager-name" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez le nom de votre manager">
                            </div>
                        </div>
                    </div>

                    <!-- File Import Section -->
                    <div id="import-section" class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                            <i class="fas fa-file-import mr-2 text-blue-500"></i>Importer les Objectifs
                        </h2>
                        <div class="file-upload p-8 text-center cursor-pointer" id="file-upload-area">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-file-excel text-4xl text-green-500 mb-3"></i>
                                <p class="text-gray-600 mb-2">Glissez-déposez votre fichier Excel d'objectifs ici</p>
                                <p class="text-sm text-gray-400 mb-4">ou</p>
                                <label for="file-input" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 cursor-pointer transition-colors">
                                    <i class="fas fa-folder-open mr-2"></i> Sélectionner un fichier
                                </label>
                                <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                            </div>
                        </div>
                        <div id="file-info" class="mt-4 hidden">
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-md">
                                <div class="flex items-center">
                                    <i class="fas fa-file-excel text-green-500 mr-2"></i>
                                    <span id="file-name" class="font-medium"></span>
                                </div>
                                <button id="remove-file" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-4 text-sm text-gray-500">
                            <p><i class="fas fa-info-circle mr-1"></i> Le fichier doit contenir uniquement la liste des objectifs à évaluer.</p>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div id="evaluation-container" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
                        <!-- Tabs -->
                        <div class="flex border-b no-print">
                            <button id="evaluation-tab" class="flex-1 py-4 px-6 font-medium text-center border-b-2 border-blue-500 text-blue-600 bg-blue-50">
                                <i class="fas fa-user-check mr-2"></i>Auto-Évaluation
                            </button>
                            <button id="results-tab" class="flex-1 py-4 px-6 font-medium text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                <i class="fas fa-chart-bar mr-2"></i>Résultats
                            </button>
                        </div>

                        <!-- Evaluation Tab Content -->
                        <div id="evaluation-content" class="p-6">
                            <div class="mb-6">
                                <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                    <i class="fas fa-user-check mr-2 text-blue-500"></i>Auto-Évaluation
                                </h2>
                                <p class="text-gray-600 mb-4">Sélectionnez le niveau d'atteinte pour chaque objectif.</p>
                                
                                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-6">
                                    <div class="flex items-start">
                                        <div class="flex-shrink-0 pt-1">
                                            <i class="fas fa-exclamation-circle text-yellow-500"></i>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-sm font-medium text-yellow-800">Comment auto-évaluer ?</h3>
                                            <div class="mt-2 text-sm text-yellow-700">
                                                <p>• Soyez objectif dans votre auto-évaluation</p>
                                                <p>• Sélectionnez le niveau d'atteinte qui correspond le mieux à vos résultats</p>
                                                <p>• Indiquez la valeur réelle obtenue pour chaque objectif</p>
                                                <p>• Le système calculera automatiquement votre score final</p>
                                                <p>• Vous pouvez ajouter des commentaires pour chaque objectif</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="evaluation-items-container">
                                    <!-- Evaluation items will be added here -->
                                </div>
                                
                                <div class="mt-6">
                                    <label class="block text-gray-700 mb-2 font-medium">
                                        <i class="fas fa-comment-dots mr-2 text-blue-500"></i>Commentaires
                                    </label>
                                    <textarea id="general-comments" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Ajoutez vos commentaires sur votre performance..."></textarea>
                                </div>
                                
                                <div class="flex justify-end mt-6 no-print">
                                    <button id="calculate-score" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md flex items-center transition-all">
                                        <i class="fas fa-calculator mr-2"></i> Calculer le Score
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Results Tab Content -->
                        <div id="results-content" class="p-6 hidden">
                            <div class="mb-6">
                                <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                                    <i class="fas fa-chart-bar mr-2 text-blue-500"></i>Résultats de l'Auto-Évaluation
                                </h2>
                                
                                <div id="results-summary" class="bg-gray-50 p-6 rounded-md mb-6 border border-gray-200">
                                    <!-- Results summary will be shown here -->
                                </div>
                                
                                <div id="results-details">
                                    <!-- Detailed results will be shown here -->
                                </div>
                                
                                <div class="flex justify-end mt-6 no-print">
                                    <button id="new-evaluation" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md flex items-center mr-2 transition-all">
                                        <i class="fas fa-redo mr-2"></i> Nouvelle Auto-Évaluation
                                    </button>
                                    <button id="print-results" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center mr-2 transition-all">
                                        <i class="fas fa-print mr-2"></i> Imprimer
                                    </button>
                                    <button id="send-to-rh" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md flex items-center transition-all">
                                        <i class="fas fa-paper-plane mr-2"></i> Partager
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Saved Evaluations Modal -->
    <div id="saved-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] overflow-hidden">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-xl font-semibold text-gray-800">Auto-Évaluations Sauvegardées</h3>
                <button id="close-saved-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto">
                <div class="mb-4">
                    <input type="text" id="search-saved" placeholder="Rechercher..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="saved-list" class="space-y-3">
                    <!-- Saved evaluations will be listed here -->
                </div>
            </div>
            <div class="border-t p-4 flex justify-end">
                <button id="cancel-saved-modal" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
    <script>
      
   
 
        document.addEventListener('DOMContentLoaded', function() {
            // Set print date
            const now = new Date();
            document.getElementById('print-date').textContent = now.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Set default evaluation date to today
            document.getElementById('evaluation-date').valueAsDate = new Date();
            
            // Sidebar toggle functionality
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const mainContent = document.getElementById('main-content');
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('sidebar-collapsed');
                mainContent.classList.toggle('ml-64');
                mainContent.classList.toggle('ml-0');
                sidebarToggle.classList.toggle('collapsed');
            });
            
            // Navigation buttons
            document.getElementById('nav-new').addEventListener('click', function() {
                resetForm();
                document.getElementById('page-subtitle').textContent = 'Importez vos objectifs et évaluez vos performances';
            });
            
            document.getElementById('nav-saved').addEventListener('click', showSavedEvaluations);
            
            // Saved evaluations modal
            const savedModal = document.getElementById('saved-modal');
            const closeSavedModal = document.getElementById('close-saved-modal');
            const cancelSavedModal = document.getElementById('cancel-saved-modal');
            
            function showSavedEvaluations() {
                savedModal.classList.remove('hidden');
                renderSavedEvaluations();
            }
            
            function hideSavedEvaluations() {
                savedModal.classList.add('hidden');
            }
            
            closeSavedModal.addEventListener('click', hideSavedEvaluations);
            cancelSavedModal.addEventListener('click', hideSavedEvaluations);
            
            // Search functionality for saved evaluations
            document.getElementById('search-saved').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const items = document.querySelectorAll('#saved-list > div');
                
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // File upload functionality
            const fileUploadArea = document.getElementById('file-upload-area');
            const fileInput = document.getElementById('file-input');
            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const removeFileBtn = document.getElementById('remove-file');
            
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('active');
            });
            
            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('active');
            });
            
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('active');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload();
                }
            });
            
            fileInput.addEventListener('change', handleFileUpload);
            
            removeFileBtn.addEventListener('click', () => {
                fileInput.value = '';
                fileInfo.classList.add('hidden');
                document.getElementById('evaluation-container').classList.add('hidden');
            });
            
            function handleFileUpload() {
                const file = fileInput.files[0];
                if (!file) return;
                
                fileName.textContent = file.name;
                fileInfo.classList.remove('hidden');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get the first sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    // Process the data to extract objectives and user info
                    const { objectives, collaborateurName, managerName, societe } = processExcelData(jsonData);
                    
                    // Fill user info if found in the file
                    if (collaborateurName) {
                        document.getElementById('collaborateur-name').value = collaborateurName;
                    }
                    if (managerName) {
                        document.getElementById('manager-name').value = managerName;
                    }
                    if (societe) {
                        document.getElementById('collaborateur-societe').value = societe;
                    }
                    
                    if (objectives.length > 0) {
                        // Show evaluation container
                        document.getElementById('evaluation-container').classList.remove('hidden');
                        
                        // Render evaluation items
                        renderEvaluationItems(objectives);
                        
                        // Switch to evaluation tab
                        evaluationTab.click();
                        
                        showAlert('Fichier importé avec succès! Les objectifs sont maintenant disponibles pour évaluation.', 'success');
                    } else {
                        showAlert('Aucun objectif trouvé dans le fichier. Veuillez vérifier le format du fichier.', 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            function processExcelData(data) {
                const objectives = [];
                let foundHeader = false;
                let collaborateurName = '';
                let managerName = '';
                let societe = '';
                
                // Look for user info and objectives in the Excel data
                for (let i = 0; i < data.length; i++) {
                    const row = data[i];
                    
                    // Skip empty rows
                    if (!row || row.length === 0) continue;
                    
                    // Try to extract user info from specific cells
                    if (row[0] && typeof row[0] === 'string') {
                        const lowerRow0 = row[0].toString().toLowerCase();
                        
                        // Check for collaborateur name
                        if (lowerRow0.includes('collaborateur') || lowerRow0.includes('nom') || lowerRow0.includes('prénom')) {
                            if (row[1] && typeof row[1] === 'string') {
                                collaborateurName = row[1].trim();
                            }
                        }
                        
                        // Check for manager name
                        if (lowerRow0.includes('manager') || lowerRow0.includes('responsable') || lowerRow0.includes('n+1')) {
                            if (row[1] && typeof row[1] === 'string') {
                                managerName = row[1].trim();
                            }
                        }
                        
                        // Check for société
                        if (lowerRow0.includes('société') || lowerRow0.includes('entreprise') || lowerRow0.includes('filiale')) {
                            if (row[1] && typeof row[1] === 'string') {
                                societe = row[1].trim();
                            }
                        }
                    }
                    
                    // Look for the objectives header row (assuming first column contains "Objectif")
                    if (!foundHeader && row[0] && row[0].toString().toLowerCase().includes('objectif')) {
                        foundHeader = true;
                        continue;
                    }
                    
                    // If header found, process data rows
                    if (foundHeader) {
                        // Check if this is a valid objective row (first column not empty)
                        if (row[0] && typeof row[0] === 'string' && row[0].trim() !== '') {
                            const isExceptional = row[0].toLowerCase().includes('exceptionnel');
                            
                            objectives.push({
                              description: row[0].trim(),
                              weight: row[1] ? parseInt(row[1]) : 0,
                              floor: row[2] ? row[2].toString().trim() : '',
                              satisfactory: row[3] ? row[3].toString().trim() : '', // Satisfaisant
                              goodPerformance: row[4] ? row[4].toString().trim() : '', // Bonne performance
                              target: row[5] ? row[5].toString().trim() : '',
                            
                              isExceptional: isExceptional
                            });
                        }
                    }
                }
                
                // Supprimer l'objectif 1 (premier objectif dans la liste)
                if (objectives.length > 0) {
                    objectives.shift(); // Supprime le premier élément du tableau
                }
                
                return { objectives, collaborateurName, managerName, societe };
            }
            
            // Tab switching functionality
            const evaluationTab = document.getElementById('evaluation-tab');
            const resultsTab = document.getElementById('results-tab');
            
            const evaluationContent = document.getElementById('evaluation-content');
            const resultsContent = document.getElementById('results-content');
            
            evaluationTab.addEventListener('click', () => {
                evaluationTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
                evaluationTab.classList.remove('border-transparent', 'text-gray-500', 'bg-white');
                
                resultsTab.classList.add('border-transparent', 'text-gray-500', 'bg-white');
                resultsTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                
                evaluationContent.classList.remove('hidden');
                resultsContent.classList.add('hidden');
            });
            
            resultsTab.addEventListener('click', () => {
                resultsTab.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
                resultsTab.classList.remove('border-transparent', 'text-gray-500', 'bg-white');
                
                evaluationTab.classList.add('border-transparent', 'text-gray-500', 'bg-white');
                evaluationTab.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
                
                resultsContent.classList.remove('hidden');
                evaluationContent.classList.add('hidden');
            });
            
            // Show alert function
            function showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 fade-in ${
                    type === 'error' ? 'bg-red-100 border-l-4 border-red-500 text-red-700' : 
                    type === 'info' ? 'bg-blue-100 border-l-4 border-blue-500 text-blue-700' :
                    'bg-green-100 border-l-4 border-green-500 text-green-700'
                }`;
                alertDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'info' ? 'fa-info-circle' : 'fa-check-circle'} mr-2"></i>
                        </div>
                        <div>
                            <p class="font-medium">${type === 'error' ? 'Erreur' : type === 'info' ? 'Information' : 'Succès'}</p>
                            <p>${message}</p>
                        </div>
                        <button class="ml-4 text-gray-500 hover:text-gray-700" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
            
            // Evaluation functionality
            let currentObjectives = [];
            let evaluationResults = [];
            let totalScore = 0;
            
            function renderEvaluationItems(objectives) {
    currentObjectives = objectives;
    const container = document.getElementById('evaluation-items-container');
    container.innerHTML = '';

    objectives.forEach((objective, index) => {
        const evaluationItem = document.createElement('div');
        evaluationItem.className = `evaluation-item mb-6 p-4 border rounded-md ${objective.isExceptional ? 'bg-purple-50' : 'bg-white'} fade-in`;

        evaluationItem.innerHTML = `
            <div class="mb-3">
                <h3 class="font-medium text-gray-700 flex items-center">
                    <i class="${objective.isExceptional ? 'fas fa-star mr-2 text-purple-500' : 'fas fa-bullseye mr-2 text-blue-500'}"></i>
                    ${objective.isExceptional ? 'Objectif Exceptionnel' : `Objectif ${index + 1}`}: ${objective.description}
                </h3>
                <div class="flex flex-wrap items-center text-sm text-gray-500 mt-1">
                    <span class="mr-3"><span class="font-medium">Poids:</span> ${objective.weight}%</span>
                    <span class="mr-3"><span class="font-medium">Seuil de départ:</span> ${objective.floor}</span>
                    <span class="mr-3"><span class="font-medium">Satisfaisant:</span> ${objective.satisfactory}</span>
                    <span class="mr-3"><span class="font-medium">Bonne performance:</span> ${objective.goodPerformance}</span>
                    <span class="mr-3"><span class="font-medium">Cible:</span> ${objective.target}</span>
                </div>
            </div>
            <div class="mb-3">
                <label class="block text-gray-700 mb-2">Niveau d'Atteinte</label>
                <div class="grid grid-cols-1 sm:grid-cols-${objective.isExceptional ? '6' : '5'} gap-2">
                    <div class="achievement-level text-center p-2 border rounded-md" data-level="0">
                        <div class="text-xs font-semibold text-red-500">Non Atteint</div>
                        <div class="text-sm">0%</div>
                    </div>
                    <div class="achievement-level text-center p-2 border rounded-md" data-level="25">
                        <div class="text-xs font-semibold text-orange-500">Avancement limité</div>
                        <div class="text-sm">25%</div>
                    </div>
                    <div class="achievement-level text-center p-2 border rounded-md" data-level="50">
                        <div class="text-xs font-semibold text-yellow-500">Réalisation incomplète</div>
                        <div class="text-sm">50%</div>
                    </div>
                    <div class="achievement-level text-center p-2 border rounded-md" data-level="75">
                        <div class="text-xs font-semibold text-green-500">Résultat satisfaisant</div>
                        <div class="text-sm">75%</div>
                    </div>
                    <div class="achievement-level text-center p-2 border rounded-md" data-level="100">
                        <div class="text-xs font-semibold text-blue-500">Atteint</div>
                        <div class="text-sm">100%</div>
                    </div>
                    ${objective.isExceptional ? `
                    <div class="achievement-level text-center p-2 border rounded-md" data-level="120">
                        <div class="text-xs font-semibold text-purple-500">Exceptionnel</div>
                        <div class="text-sm">120%</div>
                    </div>
                    ` : ''}
                </div>
            </div>
            <div class="mb-3">
                <label class="block text-gray-700 mb-2">Valeur Réelle Obtenue</label>
                <input type="text" class="actual-value w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Entrez la valeur réelle (ex: 85 ventes)">
            </div>
            <div class="mb-3">
                <label class="block text-gray-700 mb-2">Commentaires</label>
                <textarea class="comments w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500" rows="2" placeholder="Ajoutez vos commentaires sur cet objectif"></textarea>
            </div>
        `;

        container.appendChild(evaluationItem);

        // Add event listeners for achievement levels
        const levels = evaluationItem.querySelectorAll('.achievement-level');
        levels.forEach(level => {
            level.addEventListener('click', function() {
                // Remove selected class from all levels in this item
                levels.forEach(l => l.classList.remove('selected'));

                // Add selected class to clicked level
                this.classList.add('selected');
            });
        });
    });
}
            
            // Calculate score functionality
            document.getElementById('calculate-score').addEventListener('click', calculateScore);
            
            function calculateScore() {
                const employeeName = document.getElementById('collaborateur-name').value;
                const managerName = document.getElementById('manager-name').value;
                const company = document.getElementById('collaborateur-societe').value;
                const date = document.getElementById('evaluation-date').value;
                const generalComments = document.getElementById('general-comments').value;
                
                if (!employeeName) {
                    showAlert('Veuillez entrer votre nom.', 'error');
                    return;
                }
                
                if (!managerName) {
                    showAlert('Veuillez entrer le nom de votre manager.', 'error');
                    return;
                }
                
                evaluationResults = [];
                totalScore = 0;
                let hasError = false;
                
                const evaluationItems = document.querySelectorAll('.evaluation-item');
                
                evaluationItems.forEach((item, index) => {
                    const objective = currentObjectives[index];
                    
                    const selectedLevel = item.querySelector('.achievement-level.selected');
                    const actualValue = item.querySelector('.actual-value').value;
                    const comments = item.querySelector('.comments').value;
                    
                    if (!selectedLevel || !actualValue) {
                        showAlert('Veuillez sélectionner un niveau d\'atteinte et entrer une valeur réelle pour tous les objectifs.', 'error');
                        hasError = true;
                        return;
                    }
                    
                    let achievementPercentage = parseInt(selectedLevel.dataset.level);
                    
                    // For exceptional objectives, we can go up to 120%
                    if (objective.isExceptional && achievementPercentage > 120) {
                        achievementPercentage = Math.min(achievementPercentage, 120);
                    }
                    
                    const score = (achievementPercentage / 100) * objective.weight;
                    
                    evaluationResults.push({
                        description: objective.description,
                        weight: objective.weight,
                        actualValue,
                        achievementPercentage,
                        score,
                        comments,
                        isExceptional: objective.isExceptional
                    });
                    
                    totalScore += score;
                });
                
                if (hasError) return;
                
                // Save evaluation to local storage
                saveEvaluationToLocalStorage(employeeName, managerName, company, date, generalComments);
                
                // Render results
                renderResults(employeeName, managerName, totalScore);
                resultsTab.click();
                
                showAlert('Auto-évaluation terminée et sauvegardée avec succès!', 'success');
            }
            
            function saveEvaluationToLocalStorage(employeeName, managerName, company, date, generalComments) {
                let savedEvaluations = JSON.parse(localStorage.getItem('savedAutoEvaluations')) || [];
                
                savedEvaluations.push({
                    id: Date.now(),
                    employeeName,
                    managerName,
                    company,
                    date,
                    objectives: currentObjectives,
                    results: evaluationResults,
                    totalScore,
                    generalComments,
                    status: 'completed'
                });
                
                localStorage.setItem('savedAutoEvaluations', JSON.stringify(savedEvaluations));
            }
            
            function renderSavedEvaluations() {
                const savedList = document.getElementById('saved-list');
                const savedEvaluations = JSON.parse(localStorage.getItem('savedAutoEvaluations')) || [];
                
                savedList.innerHTML = '';
                
                if (savedEvaluations.length === 0) {
                    savedList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-folder-open text-4xl mb-2"></i>
                            <p>Aucune auto-évaluation sauvegardée</p>
                        </div>
                    `;
                    return;
                }
                
                savedEvaluations.forEach(evaluation => {
                    const evaluationElement = document.createElement('div');
                    evaluationElement.className = 'border rounded-md p-4 hover:bg-gray-50 cursor-pointer transition-colors';
                    evaluationElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium text-gray-800">${evaluation.employeeName}</h4>
                                <p class="text-sm text-gray-500">${evaluation.company}</p>
                                <p class="text-xs text-gray-400 mt-1">Manager: ${evaluation.managerName}</p>
                                <p class="text-xs text-gray-400">Date: ${new Date(evaluation.date).toLocaleDateString('fr-FR')}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="load-evaluation px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600" data-id="${evaluation.id}">
                                    <i class="fas fa-eye mr-1"></i> Voir
                                </button>
                                <button class="delete-evaluation px-3 py-1 bg-red-500 text-white rounded-md text-sm hover:bg-red-600" data-id="${evaluation.id}">
                                    <i class="fas fa-trash mr-1"></i> Supprimer
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Auto-évaluation terminée
                            </span>
                            <span class="inline-block ml-2 px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                Score: ${evaluation.totalScore?.toFixed(1) || 'N/A'}%
                            </span>
                        </div>
                    `;
                    
                    savedList.appendChild(evaluationElement);
                    
                    // Add event listeners to buttons
                    evaluationElement.querySelector('.load-evaluation').addEventListener('click', function() {
                        loadEvaluation(evaluation.id);
                        hideSavedEvaluations();
                    });
                    
                    evaluationElement.querySelector('.delete-evaluation').addEventListener('click', function() {
                        if (confirm('Êtes-vous sûr de vouloir supprimer cette auto-évaluation ?')) {
                            deleteEvaluation(evaluation.id);
                            renderSavedEvaluations();
                        }
                    });
                });
            }
            
            function loadEvaluation(id) {
                const savedEvaluations = JSON.parse(localStorage.getItem('savedAutoEvaluations')) || [];
                const evaluation = savedEvaluations.find(e => e.id == id);
                
                if (!evaluation) {
                    showAlert('Auto-évaluation non trouvée.', 'error');
                    return;
                }
                
                // Fill the form
                document.getElementById('collaborateur-name').value = evaluation.employeeName;
                document.getElementById('manager-name').value = evaluation.managerName;
                document.getElementById('collaborateur-societe').value = evaluation.company;
                document.getElementById('evaluation-date').value = evaluation.date;
                document.getElementById('general-comments').value = evaluation.generalComments || '';
                
                // Show evaluation container
                document.getElementById('evaluation-container').classList.remove('hidden');
                
                // Render evaluation items
                renderEvaluationItems(evaluation.objectives);
                
                // Set selected levels and values
                evaluation.results.forEach((result, index) => {
                    const item = document.querySelectorAll('.evaluation-item')[index];
                    if (item) {
                        // Select achievement level
                        const level = item.querySelector(`.achievement-level[data-level="${result.achievementPercentage}"]`);
                        if (level) level.classList.add('selected');
                        
                        // Set actual value
                        item.querySelector('.actual-value').value = result.actualValue;
                        
                        // Set comments
                        item.querySelector('.comments').value = result.comments || '';
                    }
                });
                
                // Render results
                renderResults(evaluation.employeeName, evaluation.managerName, evaluation.totalScore);
                
                // Update UI
                document.getElementById('page-subtitle').textContent = `Auto-évaluation de ${evaluation.employeeName}`;
                resultsTab.click();
            }
            
            function deleteEvaluation(id) {
                let savedEvaluations = JSON.parse(localStorage.getItem('savedAutoEvaluations')) || [];
                savedEvaluations = savedEvaluations.filter(e => e.id != id);
                localStorage.setItem('savedAutoEvaluations', JSON.stringify(savedEvaluations));
                
                showAlert('Auto-évaluation supprimée avec succès.', 'success');
            }
            
            function getPerformanceLevel(score) {
                if (score < 50) return { level: 'Insuffisant', color: 'red' };
                if (score < 70) return { level: 'En développement', color: 'orange' };
                if (score < 90) return { level: 'Compétent', color: 'yellow' };
                if (score < 110) return { level: 'Très compétent', color: 'green' };
                return { level: 'Exceptionnel', color: 'blue' };
            }
            
            function renderResults(employeeName, managerName, totalScore) {
                const performance = getPerformanceLevel(totalScore);
                
                // SummaryRH ORBIS
                document.getElementById('results-summary').innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                        <div class="mb-4 md:mb-0">
                            <h3 class="text-lg font-semibold text-gray-800">Résumé de l'Auto-Évaluation</h3>
                            <p class="text-gray-600">Collaborateur: <span class="font-medium">${employeeName}</span></p>
                            <p class="text-gray-600">Manager: <span class="font-medium">${managerName}</span></p>
                            <p class="text-gray-600">Date: <span class="font-medium">${new Date().toLocaleDateString('fr-FR')}</span></p>
                        </div>
                       
                       <div class="text-center">
            <div class="text-4xl font-bold text-blue-600">${totalScore.toFixed(1)}%</div>
            <div class="text-sm text-gray-500">Score Final</div>
            <span class="inline-block mt-2 px-3 py-1 rounded-full text-xs font-medium bg-${performance.color}-100 text-${performance.color}-800">
                ${performance.level}
                      </span>
        </div>
     
    </div>

    <div>


    </div>
    
    <div>
    
    </div>
   
</div>
                    <div class="mt-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>0%</span>
                            
                            <span>120%</span>
                        </div>
    <div class="progress-bar">
    <div class="progress-fill bg-blue-500" 
         style="width: ${Math.min(totalScore / 1.2, 100)}%; background-color: ${totalScore > 100 ? 'green' : 'blue'};">
    </div>
</div>
                `;
                
                // Details
                document.getElementById('results-details').innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Détails par Objectif</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700">
                                    <th class="py-3 px-4 text-left">Objectif</th>
                                    <th class="py-3 px-4 text-center">Poids</th>
                                    <th class="py-3 px-4 text-center">Valeur Réelle</th>
                                    <th class="py-3 px-4 text-center">Atteinte</th>
                                    <th class="py-3 px-4 text-center">Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${evaluationResults.map((result, index) => `
                                    <tr class="border-b ${result.isExceptional ? 'bg-purple-50' : ''}">
                                        <td class="py-3 px-4">
                                            <div class="font-medium flex items-center">
                                                ${result.isExceptional ? '<i class="fas fa-star mr-2 text-purple-500"></i>' : ''}
                                                ${result.isExceptional ? 'Objectif Exceptionnel' : `Objectif ${index + 1}`}
                                            </div>
                                            <div class="text-sm text-gray-500">${result.description}</div>
                                            ${result.comments ? `<div class="mt-1 text-xs text-gray-400"><i class="fas fa-comment mr-1"></i>${result.comments}</div>` : ''}
                                        </td>
                                        <td class="py-3 px-4 text-center">${result.weight}%</td>
                                        <td class="py-3 px-4 text-center">${result.actualValue}</td>
                                        <td class="py-3 px-4 text-center">
                                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium 
                                                ${result.achievementPercentage === 0 ? 'bg-red-100 text-red-800' : 
                                                  result.achievementPercentage === 25 ? 'bg-orange-100 text-orange-800' : 
                                                  result.achievementPercentage === 50 ? 'bg-yellow-100 text-yellow-800' : 
                                                  result.achievementPercentage === 75 ? 'bg-green-100 text-green-800' : 
                                                  result.achievementPercentage === 100 ? 'bg-blue-100 text-blue-800' : 
                                                  'bg-purple-100 text-purple-800'}">
                                                ${result.achievementPercentage}%
                                            </span>
                                        </td>
                                        <td class="py-3 px-4 text-center font-medium">${result.score.toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td class="py-3 px-4 text-right font-medium" colspan="4">Score Total:</td>
                                    <td class="py-3 px-4 text-center font-bold text-blue-600">${totalScore.toFixed(1)}%</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    ${document.getElementById('general-comments').value ? `
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Commentaires</h3>
                        <div class="bg-gray-50 p-4 rounded-md border border-gray-200">
                            <p>${document.getElementById('general-comments').value}</p>
                        </div>
                    </div>
                    ` : ''}
                `;
            }
            
            // New evaluation button
            document.getElementById('new-evaluation').addEventListener('click', resetForm);
            
            // Print results button
            document.getElementById('print-results').addEventListener('click', () => {
                window.print();
            });
            
            // Send to RH button
            document.getElementById('send-to-rh').addEventListener('click', sendToRH);
            
            function sendToRH() {
                const employeeName = document.getElementById('collaborateur-name').value || 'Collaborateur';
                const managerName = document.getElementById('manager-name').value || 'Manager';
                const company = document.getElementById('collaborateur-societe').value || 'Société inconnue';
                const date = document.getElementById('evaluation-date').value || new Date().toISOString().split('T')[0];
                const generalComments = document.getElementById('general-comments').value || 'Aucun commentaire';
                
                if (!evaluationResults || evaluationResults.length === 0) {
                    showAlert('Aucun résultat d\'auto-évaluation à envoyer.', 'error');
                    return;
                }
                
                // Create Excel file
                const wb = XLSX.utils.book_new();
                
                // Create data for the sheet
                const data = [
                    ['Nom du Collaborateur', employeeName],
                    ['Société', company],
                    ['Manager (N+1)', managerName],
                    ['Date', date],
                    ['Score Final', totalScore.toFixed(1) + '%'],
                    ['Commentaires', generalComments],
                    [],
                    ['Détails des Objectifs'],
                    ['Objectif', 'Poids (%)', 'Valeur Réelle', 'Atteinte (%)', 'Score Obtenu (%)', 'Commentaires']
                ];
                
                // Add each objective
                evaluationResults.forEach(obj => {
                    data.push([
                        obj.description,
                        obj.weight,
                        obj.actualValue,
                        obj.achievementPercentage,
                        obj.score.toFixed(1),
                        obj.comments || ''
                    ]);
                });
                
                // Add summary at the end
                data.push([], ['Résumé']);
                data.push(['Score Total', '', '', '', totalScore.toFixed(1) + '%']);
                
                const sheet = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, sheet, "Auto-Évaluation");
                
                // Generate file name
                const fileName = `AutoEvaluation_${employeeName.replace(/\s+/g, '_')}_${date}.xlsx`;
                
                // Save the file
                XLSX.writeFile(wb, fileName);
                
                // Prepare email
                const to = "rh@orbis.com"; // Replace with actual RH email
                const subject = encodeURIComponent(`Auto-Évaluation - ${employeeName}`);
                const body = encodeURIComponent(
                    `Bonjour,\n\n` +
                    `Veuillez trouver ci-joint mon auto-évaluation des objectifs.\n\n` +
                    `Nom: ${employeeName}\n` +
                    `Société: ${company}\n` +
                    `Manager: ${managerName}\n` +
                    `Date: ${date}\n` +
                    `Score Final: ${totalScore.toFixed(1)}%\n\n` +
                    `Cordialement,\n` +
                    `${employeeName}`
                );
                
                // Open default email client
                window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
                
                showAlert('Le fichier Excel a été généré. Veuillez l\'attacher à votre email.', 'success');
            }
            
            function resetForm() {
                document.getElementById('collaborateur-name').value = '';
                document.getElementById('manager-name').value = '';
                document.getElementById('collaborateur-societe').value = '';
                document.getElementById('evaluation-date').valueAsDate = new Date();
                document.getElementById('general-comments').value = '';
                
                document.getElementById('file-input').value = '';
                document.getElementById('file-info').classList.add('hidden');
                document.getElementById('evaluation-container').classList.add('hidden');
                
                document.getElementById('page-subtitle').textContent = 'Importez vos objectifs et évaluez vos performances';
            }
            
            // Initialize
            resetForm();
        });
        document.addEventListener('DOMContentLoaded', function () {
    const userEmail = localStorage.getItem('userEmail'); // Récupère l'email de l'utilisateur depuis le localStorage
    const welcomeMessage = document.getElementById('welcome-message');

    if (userEmail && welcomeMessage) {
        welcomeMessage.textContent = `Bienvenue, ${userEmail.split('@')[0]} !`; // Affiche le message de bienvenue
    } else {
        welcomeMessage.textContent = 'Bienvenue !'; // Message par défaut si aucune information n'est disponible
    }
});
    </script>
</body>
</html>

